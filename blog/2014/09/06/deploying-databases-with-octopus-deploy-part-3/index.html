
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Deploying databases with Octopus Deploy Part 3 - Another Level of Indirection</title>
  <meta name="author" content="Dan Piessens">

  
  <meta name="description" content="Completing my series on deploying databases with Octopus Deploy, I want to cover how to deal with a common gap when working with SQL Database &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://dpiessens.github.io/blog/2014/09/06/deploying-databases-with-octopus-deploy-part-3/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Another Level of Indirection" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=Arvo:400,400italic,700,700italic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Merienda:700" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-46643958-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
  <div id="navigation">
    <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:dpiessens.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  </div>
  <header role="banner"><hgroup>
  <h1><a href="/">Another Level of Indirection</a></h1>
  
    <h2>A journey through the endless maze of Agile, DevOps, technology and life.</h2>
  
</hgroup>

</header>
  <div id="body"  >
    <div id="main">
      <div id="content">
        <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Deploying Databases With Octopus Deploy Part 3</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-06T15:00:00-05:00" pubdate data-updated="true">Sep 6<span>th</span>, 2014</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Completing my series on deploying databases with Octopus Deploy, I want to cover how to deal with a common gap when working with SQL Database Projects and SQL Server Data Tools (SSDT): seeding data into the database.</p>

<p>Most people deal with this by using PostDeployment SQL scripts that do merge queries to insert or update the data. While this technique works, the data isn&rsquo;t very readable and can be difficult to maintain as the data set or number of tables grow. It can also be difficult to work around foreign key constraints to make sure data is loaded in the correct order. Allow me to present an alternative&hellip;</p>

<!-- more -->


<h2>Introducing DatabaseDataLoader</h2>

<p>I created a simple, open source utility to simplify the problem. The tool is based on using CSV files which can be easily maintained both in a text editor and tools like Microsoft Excel. The file name should match the table being loaded. So if I&rsquo;m loading a table named <em>Accounts</em> then the file should be <em>Accounts.csv</em>.</p>

<p>You can download the latest version of the tool here: <a href="https://github.com/dpiessens/DatabaseDataLoader/releases">https://github.com/dpiessens/DatabaseDataLoader/releases</a></p>

<p>The folder structure dictates how things should be loaded. A top level folder groups the type of data. I like to use &ldquo;base&rdquo; for the core data, then a folder for each environment to hold things like test data. Inside those folders should be two additional folders: InsertOnly and Updateable. Files in InsertOnly will be checked by primary key and if the record exists it will be skipped. Files in Updateable will get inserted or updated on each run. Here&rsquo;s an example structure:</p>

<p><img src="/images/posts/DatabaseDataLoader/FileStructure.png"></p>

<p>To run the loader simply call the executable with a connection string and a base path similar to this:</p>

<p><code>
DatabaseDataLoader.exe -baseDir &lt;baseDirectory&gt; -connection &lt;connectionString&gt;
</code></p>

<p>The <em>connection</em> argument should be a .NET connection string to the database that is loaded. The <em>baseDir</em> argument specifies the base directory to load data from. From the sample above, it would either be the full path to <em>base</em> or <em>QA</em>.</p>

<p>The tool makes it easy to edit data, update it and load it in. Nothing special really needs to be done to the CSV files, the main idea is that data is loaded with the database constraints disabled so that ordering, hierarchy etc. do not need to be maintained. The tool reflects the actual database schema and does all the appropriate data conversions so data is validated on insert and failures will be reflected for all lines that don&rsquo;t load correctly.</p>

<h2>Using the loader with a database deploy</h2>

<p>Similar to <a href="http://dpiessens.github.io/blog/2014/06/10/deploying-databases-with-octopus-deploy-part-2" title="Part 2">Part 2</a>, you will need a Deploy.ps1 file, but this one will load the data in addition to deploying any schema update. The additional scripting will load the base data first, then look at the target environment name and look for a matching directory. If it finds that it will do the load on that directory as well. A sample file looks like this:</p>

<figure class='code'><figcaption><span>Deployment Script (Deploy.ps1)</span> <a href='/downloads/code/DeployingDatabasesWithOctopus3/Deploy.ps1'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='ps1'><span class='line'><span class="err">ï»¿</span>
</span><span class='line'><span class="c"># These variables should be set via the Octopus web portal:</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#   ConnectionString         - The .Net connection string for the DB</span>
</span><span class='line'><span class="k">if</span> <span class="p">(!</span> <span class="nv">$ConnectionString</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nb">Write-Host</span> <span class="s2">&quot;Missing required variable ConnectionString&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span class='line'>  <span class="n">exit</span> <span class="n">1</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Default SkipDataLoad Variable to False</span>
</span><span class='line'><span class="k">if</span> <span class="p">(!</span><span class="nv">$SkipDataLoad</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nv">$SkipDataLoad</span> <span class="p">=</span> <span class="nv">$false</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Internal Variables</span>
</span><span class='line'><span class="nv">$contentPath</span>  <span class="p">=</span> <span class="p">(</span><span class="nb">Join-Path</span> <span class="nv">$OctopusOriginalPackageDirectoryPath</span> <span class="s2">&quot;content&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nv">$dbFileName</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-ChildItem</span> <span class="nv">$contentPath</span><span class="p">\*.</span><span class="n">dacpac</span> <span class="n">-Name</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-First</span> <span class="n">1</span><span class="p">)</span>
</span><span class='line'><span class="nv">$dbFilePath</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Join-Path</span> <span class="nv">$contentPath</span> <span class="nv">$dbFileName</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$publishSettingsPath</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Join-Path</span> <span class="nv">$contentPath</span> <span class="s2">&quot;DeploySettings.publish.xml&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$sqlPackageDir</span> <span class="p">=</span> <span class="s2">&quot;${Env:ProgramFiles(x86)}\Microsoft SQL Server\110\DAC\bin&quot;</span>
</span><span class='line'><span class="nv">$sqlPackageExe</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Join-Path</span> <span class="nv">$sqlPackageDir</span> <span class="s2">&quot;SqlPackage.exe&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$dataLoaderPath</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Join-Path</span> <span class="nv">$OctopusOriginalPackageDirectoryPath</span> <span class="s2">&quot;tools&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nv">$dataLoaderExe</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Join-Path</span> <span class="nv">$dataLoaderPath</span> <span class="s2">&quot;DatabaseDataLoader.exe&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Write all variables to build</span>
</span><span class='line'><span class="nb">Write-Host</span> <span class="s2">&quot;Db File Path:&quot;</span> <span class="nv">$dbFilePath</span>
</span><span class='line'><span class="nb">Write-Host</span> <span class="s2">&quot;Sql Exe File Path:&quot;</span> <span class="nv">$sqlPackageExe</span>
</span><span class='line'><span class="nb">Write-Host</span> <span class="s2">&quot;Data Loader Path:&quot;</span> <span class="nv">$dataLoaderExe</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Run the deployment tool</span>
</span><span class='line'><span class="nb">Set-Location</span> <span class="nv">$sqlPackageDir</span>
</span><span class='line'><span class="p">&amp;</span> <span class="nv">$sqlPackageExe</span> <span class="p">/</span><span class="n">Action</span><span class="err">:</span><span class="n">Publish</span> <span class="p">/</span><span class="n">SourceFile</span><span class="err">:</span><span class="s2">&quot;$dbFilePath&quot;</span> <span class="p">/</span><span class="n">TargetConnectionString</span><span class="err">:</span><span class="s2">&quot;$ConnectionString&quot;</span> <span class="p">/</span><span class="n">Profile</span><span class="err">:</span><span class="s2">&quot;$publishSettingsPath&quot;</span> <span class="p">|</span> <span class="nb">Write-Host</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Manual skip of data load</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$SkipDataLoad</span> <span class="o">-eq</span> <span class="nv">$true</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nb">Write-Host</span> <span class="s2">&quot;Data Load manually skipped&quot;</span>
</span><span class='line'>  <span class="n">Exit</span> <span class="n">0</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Run the data load utility</span>
</span><span class='line'><span class="nv">$baseDataPath</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Join-Path</span> <span class="nv">$contentPath</span> <span class="s2">&quot;Data&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nv">$commonDataPath</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Join-Path</span> <span class="nv">$baseDataPath</span> <span class="s2">&quot;base&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(!(</span><span class="nb">Test-Path</span> <span class="nv">$baseDataPath</span><span class="p">))</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nb">Write-Host</span> <span class="s2">&quot;No Data Directory Exists&quot;</span>
</span><span class='line'>  <span class="n">Exit</span> <span class="n">0</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">Write-Host</span> <span class="s2">&quot;Loading Common Data... Path:&quot;</span> <span class="nv">$commonDataPath</span>
</span><span class='line'><span class="p">&amp;</span> <span class="nv">$dataLoaderExe</span> <span class="n">-baseDir</span><span class="err">:</span><span class="s2">&quot;$commonDataPath&quot;</span> <span class="s2">&quot;-connection:$ConnectionString&quot;</span> <span class="p">|</span> <span class="nb">Write-Host</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$envDataPath</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Join-Path</span> <span class="nv">$baseDataPath</span> <span class="nv">$OctopusEnvironmentName</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$envDataPath</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nb">Write-Host</span> <span class="s2">&quot;Loading Environment Data... Path:&quot;</span> <span class="nv">$commonDataPath</span>
</span><span class='line'>  <span class="p">&amp;</span> <span class="nv">$dataLoaderExe</span> <span class="n">-baseDir</span><span class="err">:</span><span class="s2">&quot;$envDataPath&quot;</span> <span class="s2">&quot;-connection:$ConnectionString&quot;</span> <span class="p">|</span> <span class="nb">Write-Host</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that the tooling expects that DatabaseDataLoader.exe is packed up with the rest of the deployment, so it should be checked into your database project. Normally I would do this as a NuGet package, but database projects don&rsquo;t support NuGet at this point. Also I added a global variable called <em>$SkipDataLoad</em> so you can disable it if you need to for any reason during the deployment process.</p>

<p>Hopefully you&rsquo;ve found this series helpful with deploying databases, until next time, keep pushing to production!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Dan Piessens</span></span>

      








  


<time datetime="2014-09-06T15:00:00-05:00" pubdate data-updated="true">Sep 6<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/dot-net/'>.NET,</a>, <a class='category' href='/blog/categories/continuous/'>Continuous</a>, <a class='category' href='/blog/categories/database/'>Database,</a>, <a class='category' href='/blog/categories/delivery/'>Delivery]</a>, <a class='category' href='/blog/categories/deploy/'>Deploy,</a>, <a class='category' href='/blog/categories/deployment/'>Deployment,</a>, <a class='category' href='/blog/categories/octopus/'>Octopus</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://dpiessens.github.io/blog/2014/09/06/deploying-databases-with-octopus-deploy-part-3/" data-via="dpiessens" data-counturl="http://dpiessens.github.io/blog/2014/09/06/deploying-databases-with-octopus-deploy-part-3/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/08/13/that-conference-2014-presentation/" title="Previous Post: That Conference 2014 Presentation">&laquo; That Conference 2014 Presentation</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/11/17/wi-net-user-group-slides/" title="Next Post: WI .NET user group slides">WI .NET user group slides &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><script type="text/javascript">
      var disqus_shortname = 'gustavocasogithubio';
      
        
        var disqus_identifier = 'http://gustavocaso.github.io/2014/04/integrate-disqus-with-octopress/';
        var disqus_url = 'http://gustavocaso.github.io/2014/04/integrate-disqus-with-octopress/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/11/17/wi-net-user-group-slides/">WI .NET user group slides</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/06/deploying-databases-with-octopus-deploy-part-3/">Deploying databases with Octopus Deploy Part 3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/13/that-conference-2014-presentation/">That Conference 2014 Presentation</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/05/building-stable-cloud-applications-agile-2014/">Building Stable Cloud Applications: Agile 2014</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/10/deploying-databases-with-octopus-deploy-part-2/">Deploying Databases With Octopus Deploy: Part 2</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/dpiessens">@dpiessens</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'dpiessens',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


      </div>
    </div>
    <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Dan Piessens -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>. Design by <a href="http://octopressthemes.com">Octopress Themes</a></span>
</p>

</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'dpiessens';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://dpiessens.github.io/blog/2014/09/06/deploying-databases-with-octopus-deploy-part-3/';
        var disqus_url = 'http://dpiessens.github.io/blog/2014/09/06/deploying-databases-with-octopus-deploy-part-3/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





  </div>
</body>
</html>
