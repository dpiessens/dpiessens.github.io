<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Continuous | Another Level of Indirection]]></title>
  <link href="http://dpiessens.github.io/blog/categories/continuous/atom.xml" rel="self"/>
  <link href="http://dpiessens.github.io/"/>
  <updated>2014-11-17T16:11:00-06:00</updated>
  <id>http://dpiessens.github.io/</id>
  <author>
    <name><![CDATA[Dan Piessens]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Deploying databases with Octopus Deploy Part 3]]></title>
    <link href="http://dpiessens.github.io/blog/2014/09/06/deploying-databases-with-octopus-deploy-part-3/"/>
    <updated>2014-09-06T15:00:00-05:00</updated>
    <id>http://dpiessens.github.io/blog/2014/09/06/deploying-databases-with-octopus-deploy-part-3</id>
    <content type="html"><![CDATA[<p>Completing my series on deploying databases with Octopus Deploy, I want to cover how to deal with a common gap when working with SQL Database Projects and SQL Server Data Tools (SSDT): seeding data into the database.</p>

<p>Most people deal with this by using PostDeployment SQL scripts that do merge queries to insert or update the data. While this technique works, the data isn&rsquo;t very readable and can be difficult to maintain as the data set or number of tables grow. It can also be difficult to work around foreign key constraints to make sure data is loaded in the correct order. Allow me to present an alternative&hellip;</p>

<!-- more -->


<h2>Introducing DatabaseDataLoader</h2>

<p>I created a simple, open source utility to simplify the problem. The tool is based on using CSV files which can be easily maintained both in a text editor and tools like Microsoft Excel. The file name should match the table being loaded. So if I&rsquo;m loading a table named <em>Accounts</em> then the file should be <em>Accounts.csv</em>.</p>

<p>You can download the latest version of the tool here: <a href="https://github.com/dpiessens/DatabaseDataLoader/releases">https://github.com/dpiessens/DatabaseDataLoader/releases</a></p>

<p>The folder structure dictates how things should be loaded. A top level folder groups the type of data. I like to use &ldquo;base&rdquo; for the core data, then a folder for each environment to hold things like test data. Inside those folders should be two additional folders: InsertOnly and Updateable. Files in InsertOnly will be checked by primary key and if the record exists it will be skipped. Files in Updateable will get inserted or updated on each run. Here&rsquo;s an example structure:</p>

<p><img src="/images/posts/DatabaseDataLoader/FileStructure.png"></p>

<p>To run the loader simply call the executable with a connection string and a base path similar to this:</p>

<p><code>
DatabaseDataLoader.exe -baseDir &lt;baseDirectory&gt; -connection &lt;connectionString&gt;
</code></p>

<p>The <em>connection</em> argument should be a .NET connection string to the database that is loaded. The <em>baseDir</em> argument specifies the base directory to load data from. From the sample above, it would either be the full path to <em>base</em> or <em>QA</em>.</p>

<p>The tool makes it easy to edit data, update it and load it in. Nothing special really needs to be done to the CSV files, the main idea is that data is loaded with the database constraints disabled so that ordering, hierarchy etc. do not need to be maintained. The tool reflects the actual database schema and does all the appropriate data conversions so data is validated on insert and failures will be reflected for all lines that don&rsquo;t load correctly.</p>

<h2>Using the loader with a database deploy</h2>

<p>Similar to <a href="http://dpiessens.github.io/blog/2014/06/10/deploying-databases-with-octopus-deploy-part-2" title="Part 2">Part 2</a>, you will need a Deploy.ps1 file, but this one will load the data in addition to deploying any schema update. The additional scripting will load the base data first, then look at the target environment name and look for a matching directory. If it finds that it will do the load on that directory as well. A sample file looks like this:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>Deployment Script (Deploy.ps1)</span> <a href='/downloads/code/DeployingDatabasesWithOctopus3/Deploy.ps1'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='ps1'><span class='line'><span class="err">ï»¿</span>
</span><span class='line'><span class="c"># These variables should be set via the Octopus web portal:</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#   ConnectionString         - The .Net connection string for the DB</span>
</span><span class='line'><span class="k">if</span> <span class="p">(!</span> <span class="nv">$ConnectionString</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>	<span class="nb">Write-Host</span> <span class="s2">&quot;Missing required variable ConnectionString&quot;</span> <span class="n">-ForegroundColor</span> <span class="n">Yellow</span>
</span><span class='line'>	<span class="n">exit</span> <span class="n">1</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Default SkipDataLoad Variable to False</span>
</span><span class='line'><span class="k">if</span> <span class="p">(!</span><span class="nv">$SkipDataLoad</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>	<span class="nv">$SkipDataLoad</span> <span class="p">=</span> <span class="nv">$false</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Internal Variables</span>
</span><span class='line'><span class="nv">$contentPath</span>  <span class="p">=</span> <span class="p">(</span><span class="nb">Join-Path</span> <span class="nv">$OctopusOriginalPackageDirectoryPath</span> <span class="s2">&quot;content&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nv">$dbFileName</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-ChildItem</span> <span class="nv">$contentPath</span><span class="p">\*.</span><span class="n">dacpac</span> <span class="n">-Name</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-First</span> <span class="n">1</span><span class="p">)</span>
</span><span class='line'><span class="nv">$dbFilePath</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Join-Path</span> <span class="nv">$contentPath</span> <span class="nv">$dbFileName</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$publishSettingsPath</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Join-Path</span> <span class="nv">$contentPath</span> <span class="s2">&quot;DeploySettings.publish.xml&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$sqlPackageDir</span> <span class="p">=</span> <span class="s2">&quot;${Env:ProgramFiles(x86)}\Microsoft SQL Server\110\DAC\bin&quot;</span>
</span><span class='line'><span class="nv">$sqlPackageExe</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Join-Path</span> <span class="nv">$sqlPackageDir</span> <span class="s2">&quot;SqlPackage.exe&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$dataLoaderPath</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Join-Path</span> <span class="nv">$OctopusOriginalPackageDirectoryPath</span> <span class="s2">&quot;tools&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nv">$dataLoaderExe</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Join-Path</span> <span class="nv">$dataLoaderPath</span> <span class="s2">&quot;DatabaseDataLoader.exe&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Write all variables to build</span>
</span><span class='line'><span class="nb">Write-Host</span> <span class="s2">&quot;Db File Path:&quot;</span> <span class="nv">$dbFilePath</span>
</span><span class='line'><span class="nb">Write-Host</span> <span class="s2">&quot;Sql Exe File Path:&quot;</span> <span class="nv">$sqlPackageExe</span>
</span><span class='line'><span class="nb">Write-Host</span> <span class="s2">&quot;Data Loader Path:&quot;</span> <span class="nv">$dataLoaderExe</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Run the deployment tool</span>
</span><span class='line'><span class="nb">Set-Location</span> <span class="nv">$sqlPackageDir</span>
</span><span class='line'><span class="p">&amp;</span> <span class="nv">$sqlPackageExe</span> <span class="p">/</span><span class="n">Action</span><span class="err">:</span><span class="n">Publish</span> <span class="p">/</span><span class="n">SourceFile</span><span class="err">:</span><span class="s2">&quot;$dbFilePath&quot;</span> <span class="p">/</span><span class="n">TargetConnectionString</span><span class="err">:</span><span class="s2">&quot;$ConnectionString&quot;</span> <span class="p">/</span><span class="n">Profile</span><span class="err">:</span><span class="s2">&quot;$publishSettingsPath&quot;</span> <span class="p">|</span> <span class="nb">Write-Host</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Manual skip of data load</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nv">$SkipDataLoad</span> <span class="o">-eq</span> <span class="nv">$true</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>	<span class="nb">Write-Host</span> <span class="s2">&quot;Data Load manually skipped&quot;</span>
</span><span class='line'>	<span class="n">Exit</span> <span class="n">0</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Run the data load utility</span>
</span><span class='line'><span class="nv">$baseDataPath</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Join-Path</span> <span class="nv">$contentPath</span> <span class="s2">&quot;Data&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nv">$commonDataPath</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Join-Path</span> <span class="nv">$baseDataPath</span> <span class="s2">&quot;base&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(!(</span><span class="nb">Test-Path</span> <span class="nv">$baseDataPath</span><span class="p">))</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>	<span class="nb">Write-Host</span> <span class="s2">&quot;No Data Directory Exists&quot;</span>
</span><span class='line'>	<span class="n">Exit</span> <span class="n">0</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">Write-Host</span> <span class="s2">&quot;Loading Common Data... Path:&quot;</span> <span class="nv">$commonDataPath</span>
</span><span class='line'><span class="p">&amp;</span> <span class="nv">$dataLoaderExe</span> <span class="n">-baseDir</span><span class="err">:</span><span class="s2">&quot;$commonDataPath&quot;</span> <span class="s2">&quot;-connection:$ConnectionString&quot;</span> <span class="p">|</span> <span class="nb">Write-Host</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$envDataPath</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Join-Path</span> <span class="nv">$baseDataPath</span> <span class="nv">$OctopusEnvironmentName</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$envDataPath</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>	<span class="nb">Write-Host</span> <span class="s2">&quot;Loading Environment Data... Path:&quot;</span> <span class="nv">$commonDataPath</span>
</span><span class='line'>	<span class="p">&amp;</span> <span class="nv">$dataLoaderExe</span> <span class="n">-baseDir</span><span class="err">:</span><span class="s2">&quot;$envDataPath&quot;</span> <span class="s2">&quot;-connection:$ConnectionString&quot;</span> <span class="p">|</span> <span class="nb">Write-Host</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Notice that the tooling expects that DatabaseDataLoader.exe is packed up with the rest of the deployment, so it should be checked into your database project. Normally I would do this as a NuGet package, but database projects don&rsquo;t support NuGet at this point. Also I added a global variable called <em>$SkipDataLoad</em> so you can disable it if you need to for any reason during the deployment process.</p>

<p>Hopefully you&rsquo;ve found this series helpful with deploying databases, until next time, keep pushing to production!</p>
]]></content>
  </entry>
  
</feed>
