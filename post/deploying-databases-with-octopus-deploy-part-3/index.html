<!DOCTYPE html>
<html lang="en-us">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Deploying databases with Octopus Deploy Part 3 -- Another Level of Indirection</title>

    

    
    <link href="http://www.danpiessens.com/css/bootstrap.min.css" rel="stylesheet">

    
    <link href="http://www.danpiessens.com/css/clean-blog.min.css" rel="stylesheet">

    
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    
    
    
    
    
    <link href="http://www.danpiessens.com/css/prism.css" rel="stylesheet">

</head>

<body>

    
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://www.danpiessens.com/">Another Level of Indirection</a>
            </div>

                       
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    
                    <li>
                        <a href="http://www.danpiessens.com/">home</a>
                    </li>
                    
                    <li>
                        <a href="http://www.danpiessens.com/post/">Archives</a>
                    </li>
                    
                  </ul>
            </div>
           

        </div>
        
    </nav>


    
    
    <header class="intro-header" style="background-image: url('http://www.danpiessens.com/img/post-bg.jpg')">
    
      <div class="container">
        <div class="row">
           <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
             <div class="post-heading">
               <h1>Deploying Databases With Octopus Deploy Part 3</h1>
               <h2 class="subheading"></h2>
               <span class="meta">Posted by <a href="#">Dan Piessens</a> on September 6, 2014
                 <br />
                 In <a href="http://www.danpiessens.com/categories/database" >Database</a>, <a href="http://www.danpiessens.com/categories/deployment" >Deployment</a>, <a href="http://www.danpiessens.com/categories/continuous-delivery" >Continuous Delivery</a>, 

                 <br />
                 Tags <a href="http://www.danpiessens.com/tags/octopus-deploy" >octopus deploy</a> <a href="http://www.danpiessens.com/tags/database" >database</a> <a href="http://www.danpiessens.com/tags/deployment" >deployment</a> <a href="http://www.danpiessens.com/tags/.net" >.net</a> <a href="http://www.danpiessens.com/tags/continuous-delivery" >continuous delivery</a> 

               </span>
             </div>
           </div>
        </div>
      </div>
    </header>

    
    <article>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                  

<p>Completing my series on deploying databases with Octopus Deploy, I want to cover how to deal with a common gap when working with SQL Database Projects and SQL Server Data Tools (SSDT): seeding data into the database.</p>

<p>Most people deal with this by using PostDeployment SQL scripts that do merge queries to insert or update the data. While this technique works, the data isn&rsquo;t very readable and can be difficult to maintain as the data set or number of tables grow. It can also be difficult to work around foreign key constraints to make sure data is loaded in the correct order. Allow me to present an alternative&hellip;</p>

<!-- more -->

<h2 id="introducing-databasedataloader:27e6dd6eb7db9dd8cc04e86bb947cdcc">Introducing DatabaseDataLoader</h2>

<p>I created a simple, open source utility to simplify the problem. The tool is based on using CSV files which can be easily maintained both in a text editor and tools like Microsoft Excel. The file name should match the table being loaded. So if I&rsquo;m loading a table named <em>Accounts</em> then the file should be <em>Accounts.csv</em>.</p>

<p>You can download the latest version of the tool here: <a href="https://github.com/dpiessens/DatabaseDataLoader/releases">https://github.com/dpiessens/DatabaseDataLoader/releases</a></p>

<p>The folder structure dictates how things should be loaded. A top level folder groups the type of data. I like to use &ldquo;base&rdquo; for the core data, then a folder for each environment to hold things like test data. Inside those folders should be two additional folders: InsertOnly and Updateable. Files in InsertOnly will be checked by primary key and if the record exists it will be skipped. Files in Updateable will get inserted or updated on each run. Here&rsquo;s an example structure:</p>

<p>
<figure >
    
        <img src="http://www.danpiessens.com/images/post/deploying-databases-with-octopus-deploy-part-3/FileStructure.png"  />
    
    
</figure>
</p>

<p>To run the loader simply call the executable with a connection string and a base path similar to this:</p>

<p><code>
DatabaseDataLoader.exe -baseDir &lt;baseDirectory&gt; -connection &lt;connectionString&gt;
</code></p>

<p>The <em>connection</em> argument should be a .NET connection string to the database that is loaded. The <em>baseDir</em> argument specifies the base directory to load data from. From the sample above, it would either be the full path to <em>base</em> or <em>QA</em>.</p>

<p>The tool makes it easy to edit data, update it and load it in. Nothing special really needs to be done to the CSV files, the main idea is that data is loaded with the database constraints disabled so that ordering, hierarchy etc. do not need to be maintained. The tool reflects the actual database schema and does all the appropriate data conversions so data is validated on insert and failures will be reflected for all lines that don&rsquo;t load correctly.</p>

<h2 id="using-the-loader-with-a-database-deploy:27e6dd6eb7db9dd8cc04e86bb947cdcc">Using the loader with a database deploy</h2>

<p>Similar to <a href="http://www.danpiessens.com/post/deploying-databases-with-octopus-deploy-part-2">Part 2</a>, you will need a Deploy.ps1 file, but this one will load the data in addition to deploying any schema update. The additional scripting will load the base data first, then look at the target environment name and look for a matching directory. If it finds that it will do the load on that directory as well. A sample file looks like this:</p>

<p>
<pre  data-src="/downloads/code/deploying-databases-with-octopus-deploy-part-3/Deploy.ps1"></pre>
</p>

<p>Notice that the tooling expects that DatabaseDataLoader.exe is packed up with the rest of the deployment, so it should be checked into your database project. Normally I would do this as a NuGet package, but database projects don&rsquo;t support NuGet at this point. Also I added a global variable called <em>$SkipDataLoad</em> so you can disable it if you need to for any reason during the deployment process.</p>

<p>Hopefully you&rsquo;ve found this series helpful with deploying databases, until next time, keep pushing to production!</p>

                </div>
            </div>
        </div>
    </article>

    <hr>
    
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                  <ul class="list-inline text-center">
                    <li>
                      <a href="mailto:">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                    <li>
                      <a href="https://twitter.com/dpiessens">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                    <li>
                      <a href="https://github.com/dpiessens">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                  </ul>
                  <p class="copyright text-muted">2015 Dan Piessens, All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    
    <script src="http://www.danpiessens.com/js/jquery.min.js"></script>

    
    <script src="http://www.danpiessens.com/js/bootstrap.min.js"></script>

    
    <script src="http://www.danpiessens.com/js/clean-blog.js"></script>

    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-46643958-2', 'auto');
  ga('send', 'pageview');
</script>

    
    
    <script src="http://www.danpiessens.com/javascript/prism.js"></script>
...
</body>

</body>

</html>

